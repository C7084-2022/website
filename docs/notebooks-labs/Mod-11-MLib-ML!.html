<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>C7084-2022 Big Data – mod-11-mlib-ml</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../img/C7084-pad.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../img/C7084-pad.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle sidebar-tool" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Information</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Home</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../schedule.html" class="sidebar-item-text sidebar-link">Schedule</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#mod-11-spark-mllibml" id="toc-mod-11-spark-mllibml" class="nav-link active" data-scroll-target="#mod-11-spark-mllibml">Mod 11: Spark MLLIB/ML</a>
  <ul class="collapse">
  <li><a href="#lab-01---collaborative-filter---movie-recommendation-via-mllib-rdds" id="toc-lab-01---collaborative-filter---movie-recommendation-via-mllib-rdds" class="nav-link" data-scroll-target="#lab-01---collaborative-filter---movie-recommendation-via-mllib-rdds">Lab 01 - Collaborative Filter - Movie Recommendation via MLLIB (RDDs)</a></li>
  <li><a href="#lab-02-collaborative-filter---movie-recommendation-via-ml-spark-sql" id="toc-lab-02-collaborative-filter---movie-recommendation-via-ml-spark-sql" class="nav-link" data-scroll-target="#lab-02-collaborative-filter---movie-recommendation-via-ml-spark-sql">Lab 02: Collaborative Filter - Movie Recommendation via ML (Spark SQL)</a></li>
  <li><a href="#lab-03-correlation---which-correlates-most-to-wins-hits-runs-home-runs-era" id="toc-lab-03-correlation---which-correlates-most-to-wins-hits-runs-home-runs-era" class="nav-link" data-scroll-target="#lab-03-correlation---which-correlates-most-to-wins-hits-runs-home-runs-era">Lab 03: Correlation - Which Correlates most to Wins? Hits, Runs, Home Runs, ERA?</a></li>
  <li><a href="#lab-04-kmeans---divide-heart-patients-into-2-clusters" id="toc-lab-04-kmeans---divide-heart-patients-into-2-clusters" class="nav-link" data-scroll-target="#lab-04-kmeans---divide-heart-patients-into-2-clusters">Lab 04: KMeans - Divide Heart patients into 2 Clusters</a></li>
  <li><a href="#lab-05" id="toc-lab-05" class="nav-link" data-scroll-target="#lab-05">Lab 05:</a></li>
  <li><a href="#logistic-regression---goal-predict-purchase-based-on-gender-age-salary" id="toc-logistic-regression---goal-predict-purchase-based-on-gender-age-salary" class="nav-link" data-scroll-target="#logistic-regression---goal-predict-purchase-based-on-gender-age-salary">Logistic Regression - Goal: Predict Purchase based on Gender, Age, Salary</a></li>
  <li><a href="#lab-06" id="toc-lab-06" class="nav-link" data-scroll-target="#lab-06">Lab 06</a></li>
  <li><a href="#logistic-regression-again---goal-predict-income-50k-or-50k" id="toc-logistic-regression-again---goal-predict-income-50k-or-50k" class="nav-link" data-scroll-target="#logistic-regression-again---goal-predict-income-50k-or-50k">Logistic Regression again - Goal: Predict Income: &lt; $50k or &gt; $50k</a></li>
  <li><a href="#requirements" id="toc-requirements" class="nav-link" data-scroll-target="#requirements">Requirements</a></li>
  <li><a href="#step-1-load-the-data-into-schema-and-create-traintest.-then-examine-data" id="toc-step-1-load-the-data-into-schema-and-create-traintest.-then-examine-data" class="nav-link" data-scroll-target="#step-1-load-the-data-into-schema-and-create-traintest.-then-examine-data">Step 1: Load the Data into Schema and create TRAIN/TEST. Then examine data</a>
  <ul class="collapse">
  <li><a href="#lab-06a-view-file" id="toc-lab-06a-view-file" class="nav-link" data-scroll-target="#lab-06a-view-file">Lab 06a: View file</a></li>
  <li><a href="#lab-06b-create-a-schema-to-assign-column-names-and-datatypes" id="toc-lab-06b-create-a-schema-to-assign-column-names-and-datatypes" class="nav-link" data-scroll-target="#lab-06b-create-a-schema-to-assign-column-names-and-datatypes">Lab 06b: Create a Schema to assign column names and datatypes</a></li>
  <li><a href="#lab-06c-randomly-split-data-into-training-and-test-sets-and-set-seed-for-reproducibility." id="toc-lab-06c-randomly-split-data-into-training-and-test-sets-and-set-seed-for-reproducibility." class="nav-link" data-scroll-target="#lab-06c-randomly-split-data-into-training-and-test-sets-and-set-seed-for-reproducibility.">Lab 06c: Randomly split data into training and test sets, and set seed for reproducibility.</a></li>
  <li><a href="#its-best-to-split-the-data-before-doing-any-preprocessing.-this-allows-the-test-dataset-to-more-closely-simulate-new-data-when-we-evaluate-the-model." id="toc-its-best-to-split-the-data-before-doing-any-preprocessing.-this-allows-the-test-dataset-to-more-closely-simulate-new-data-when-we-evaluate-the-model." class="nav-link" data-scroll-target="#its-best-to-split-the-data-before-doing-any-preprocessing.-this-allows-the-test-dataset-to-more-closely-simulate-new-data-when-we-evaluate-the-model.">It’s best to split the data before doing any preprocessing. This allows the test dataset to more closely simulate new data when we evaluate the model.</a></li>
  <li><a href="#lab-06d-lets-review-the-dataframe" id="toc-lab-06d-lets-review-the-dataframe" class="nav-link" data-scroll-target="#lab-06d-lets-review-the-dataframe">Lab 06d: Let’s review the DataFrame</a></li>
  <li><a href="#lab-06e-whats-the-distribution-of-the-number-of-hours_per_week" id="toc-lab-06e-whats-the-distribution-of-the-number-of-hours_per_week" class="nav-link" data-scroll-target="#lab-06e-whats-the-distribution-of-the-number-of-hours_per_week">Lab 06e: What’s the distribution of the number of <code>hours_per_week</code>?</a></li>
  <li><a href="#lab-06f-how-about-education-status" id="toc-lab-06f-how-about-education-status" class="nav-link" data-scroll-target="#lab-06f-how-about-education-status">Lab 06f: How about <code>education</code> status?</a></li>
  </ul></li>
  <li><a href="#background-transformers-estimators-and-pipelines" id="toc-background-transformers-estimators-and-pipelines" class="nav-link" data-scroll-target="#background-transformers-estimators-and-pipelines">Background: Transformers, Estimators, and Pipelines</a></li>
  <li><a href="#step-2.-feature-engineering-preprocessing" id="toc-step-2.-feature-engineering-preprocessing" class="nav-link" data-scroll-target="#step-2.-feature-engineering-preprocessing">Step 2. Feature Engineering (Preprocessing)</a>
  <ul class="collapse">
  <li><a href="#lab-06g-convert-categorical-variables-to-numeric" id="toc-lab-06g-convert-categorical-variables-to-numeric" class="nav-link" data-scroll-target="#lab-06g-convert-categorical-variables-to-numeric">Lab 06g: Convert categorical variables to numeric</a></li>
  <li><a href="#lab-06h-in-this-notebook-well-build-a-pipeline-combining-all-of-our-feature-engineering-and-modeling-steps.-but-lets-take-a-minute-to-look-more-closely-at-how-estimators-and-transformers-work-by-applying-the-stringindexer-estimator-that-we-created-in-the-previous-code-block." id="toc-lab-06h-in-this-notebook-well-build-a-pipeline-combining-all-of-our-feature-engineering-and-modeling-steps.-but-lets-take-a-minute-to-look-more-closely-at-how-estimators-and-transformers-work-by-applying-the-stringindexer-estimator-that-we-created-in-the-previous-code-block." class="nav-link" data-scroll-target="#lab-06h-in-this-notebook-well-build-a-pipeline-combining-all-of-our-feature-engineering-and-modeling-steps.-but-lets-take-a-minute-to-look-more-closely-at-how-estimators-and-transformers-work-by-applying-the-stringindexer-estimator-that-we-created-in-the-previous-code-block.">Lab 06h: In this notebook, we’ll build a pipeline combining all of our feature engineering and modeling steps. But let’s take a minute to look more closely at how estimators and transformers work by applying the <code>stringIndexer</code> estimator that we created in the previous code block.</a></li>
  <li><a href="#lab-06i-combine-all-feature-columns-into-a-single-feature-vector" id="toc-lab-06i-combine-all-feature-columns-into-a-single-feature-vector" class="nav-link" data-scroll-target="#lab-06i-combine-all-feature-columns-into-a-single-feature-vector">Lab 06i: Combine all feature columns into a single feature vector</a></li>
  </ul></li>
  <li><a href="#step-3.-lab-06j-define-the-model" id="toc-step-3.-lab-06j-define-the-model" class="nav-link" data-scroll-target="#step-3.-lab-06j-define-the-model">Step 3. Lab 06j: Define the Model</a></li>
  <li><a href="#step-4.-lab-06k-build-the-pipeline-and-score-model-via-test" id="toc-step-4.-lab-06k-build-the-pipeline-and-score-model-via-test" class="nav-link" data-scroll-target="#step-4.-lab-06k-build-the-pipeline-and-score-model-via-test">Step 4. Lab 06k: Build the Pipeline and Score Model via TEST</a>
  <ul class="collapse">
  <li><a href="#lab-06l-display-the-predictions-from-the-model.-the-features-column-is-a-sparse-vector-which-is-often-the-case-after-one-hot-encoding-because-there-are-so-many-0-values." id="toc-lab-06l-display-the-predictions-from-the-model.-the-features-column-is-a-sparse-vector-which-is-often-the-case-after-one-hot-encoding-because-there-are-so-many-0-values." class="nav-link" data-scroll-target="#lab-06l-display-the-predictions-from-the-model.-the-features-column-is-a-sparse-vector-which-is-often-the-case-after-one-hot-encoding-because-there-are-so-many-0-values.">Lab 06l: Display the predictions from the Model. The <code>features</code> column is a sparse vector, which is often the case after one-hot encoding, because there are so many 0 values.</a></li>
  </ul></li>
  <li><a href="#step-5.-lab-06m-evaluate-the-model-using-roc" id="toc-step-5.-lab-06m-evaluate-the-model-using-roc" class="nav-link" data-scroll-target="#step-5.-lab-06m-evaluate-the-model-using-roc">Step 5. Lab 06m: Evaluate the Model using ROC</a></li>
  <li><a href="#step-6.-hyperparameter-tuning" id="toc-step-6.-hyperparameter-tuning" class="nav-link" data-scroll-target="#step-6.-hyperparameter-tuning">Step 6. Hyperparameter tuning</a></li>
  <li><a href="#step-7." id="toc-step-7." class="nav-link" data-scroll-target="#step-7.">Step 7.</a>
  <ul class="collapse">
  <li><a href="#lab-07" id="toc-lab-07" class="nav-link" data-scroll-target="#lab-07">Lab 07:</a></li>
  <li><a href="#goal-predict-bike-rental-counts-per-hour-using-gradient-boost-trees-regression" id="toc-goal-predict-bike-rental-counts-per-hour-using-gradient-boost-trees-regression" class="nav-link" data-scroll-target="#goal-predict-bike-rental-counts-per-hour-using-gradient-boost-trees-regression">Goal: Predict Bike rental counts (per hour) using Gradient Boost Trees Regression</a></li>
  <li><a href="#lab-08-predict-titanic-survive-not-survive-using-decision-tree" id="toc-lab-08-predict-titanic-survive-not-survive-using-decision-tree" class="nav-link" data-scroll-target="#lab-08-predict-titanic-survive-not-survive-using-decision-tree">Lab 08: Predict Titanic Survive, Not Survive using Decision Tree</a></li>
  <li><a href="#lab-08a-load-libraries-and-loadview-dataframe" id="toc-lab-08a-load-libraries-and-loadview-dataframe" class="nav-link" data-scroll-target="#lab-08a-load-libraries-and-loadview-dataframe">Lab 08a: Load Libraries and Load/View DataFrame</a></li>
  <li><a href="#lab-08b-view-data-statistics" id="toc-lab-08b-view-data-statistics" class="nav-link" data-scroll-target="#lab-08b-view-data-statistics">Lab 08b: View Data Statistics</a></li>
  <li><a href="#lab-08c-clean-the-data" id="toc-lab-08c-clean-the-data" class="nav-link" data-scroll-target="#lab-08c-clean-the-data">Lab 08c: Clean the Data</a></li>
  <li><a href="#lab-08d-convert-categorical-to-numeic-and-then-pipeline-and-transform.-then-view" id="toc-lab-08d-convert-categorical-to-numeic-and-then-pipeline-and-transform.-then-view" class="nav-link" data-scroll-target="#lab-08d-convert-categorical-to-numeic-and-then-pipeline-and-transform.-then-view">Lab 08d: Convert Categorical to Numeic and then Pipeline and Transform. Then View</a></li>
  <li><a href="#lab-08e-drop-columns-not-required" id="toc-lab-08e-drop-columns-not-required" class="nav-link" data-scroll-target="#lab-08e-drop-columns-not-required">Lab 08e: Drop Columns not Required</a></li>
  <li><a href="#lab-08f-put-all-x-variables-into-a-vector-and-transform.-then-split-into-traintest" id="toc-lab-08f-put-all-x-variables-into-a-vector-and-transform.-then-split-into-traintest" class="nav-link" data-scroll-target="#lab-08f-put-all-x-variables-into-a-vector-and-transform.-then-split-into-traintest">Lab 08f: Put all X-variables into a Vector and Transform. Then split into TRAIN/TEST</a></li>
  <li><a href="#lab-08g-run-decision-tree-classifer-to-create-model-then-make-prediction" id="toc-lab-08g-run-decision-tree-classifer-to-create-model-then-make-prediction" class="nav-link" data-scroll-target="#lab-08g-run-decision-tree-classifer-to-create-model-then-make-prediction">Lab 08g: Run Decision Tree Classifer to create Model then make Prediction</a></li>
  <li><a href="#lab-08h-evaluate-accuracy-of-decision-tree" id="toc-lab-08h-evaluate-accuracy-of-decision-tree" class="nav-link" data-scroll-target="#lab-08h-evaluate-accuracy-of-decision-tree">Lab 08h: Evaluate Accuracy of Decision Tree</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#end-of-mod-11-mlib-ml" id="toc-end-of-mod-11-mlib-ml" class="nav-link" data-scroll-target="#end-of-mod-11-mlib-ml">End of Mod-11 (MLib-ML)</a>
  <ul class="collapse">
  <li><a href="#ignore-past-here" id="toc-ignore-past-here" class="nav-link" data-scroll-target="#ignore-past-here">Ignore Past here</a>
  <ul class="collapse">
  <li><a href="#bonus-lab" id="toc-bonus-lab" class="nav-link" data-scroll-target="#bonus-lab">Bonus Lab</a></li>
  <li><a href="#goal-linear-regression-predict-home-prices" id="toc-goal-linear-regression-predict-home-prices" class="nav-link" data-scroll-target="#goal-linear-regression-predict-home-prices">Goal: Linear Regression: Predict Home Prices</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“f8a4c2d2-1121-450d-99e6-f475bb87c7f8”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 00a: Before we begin, confirm all files are loaded</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>display(dbutils.fs.ls(<span class="st">"dbfs:/FileStore/tables/"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<section id="mod-11-spark-mllibml" class="level1">
<h1>Mod 11: Spark MLLIB/ML</h1>
<section id="lab-01---collaborative-filter---movie-recommendation-via-mllib-rdds" class="level3">
<h3 class="anchored" data-anchor-id="lab-01---collaborative-filter---movie-recommendation-via-mllib-rdds">Lab 01 - Collaborative Filter - Movie Recommendation via MLLIB (RDDs)</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“1e52476d-a239-4b74-9917-32af9f13c22b”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">1a</span>: Let<span class="st">'s first do CF Lab via RDD (MLLib)</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="er">import org.apache.spark.mllib.recommendation.Rating</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="er">import org.apache.spark.mllib.recommendation.ALS</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="er">import org.apache.spark.mllib.recommendation.MatrixFactorizationModel</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="er">// Load data: Schema = (user, movie, rating (Min-1-5-Max), ts)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="er">val raw = sc.textFile("/FileStore/tables/u.data")</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="er">// Using Rating library, assign schema and pluck out just 3 columns you want and put into an Array</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="er">val ratings = raw.map(_.split("\t") match {case Array(user,movie,rate,ts) =&gt; Rating(user.toInt, movie.toInt, rate.toDouble)})</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="er">// Display User, Movie, Rating</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="er">ratings.take(2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“5083f571-b331-4bb7-97df-fd240040912c”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">1b</span>: Create Model: Assign rank (<span class="co"># factors), iterations, lambda (controls Overfitting)</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>val rank <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>val numIterations <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>val <span class="kw">lambda</span> <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>val model <span class="op">=</span> ALS.train(ratings, rank, numIterations, <span class="kw">lambda</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Returns (UserFeatures (Int) <span class="kw">and</span> productFeatures (Array)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>model.userFeatures.take(<span class="dv">1</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Count <span class="co"># of UserFeatures factors</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>model.userFeatures.count</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Count <span class="co"># of ProductFeatures factors</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>model.productFeatures.count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“ec61c919-7506-4fda-81a2-1ce20cf109d4”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">1c</span>: Map MovieID to MovieName using <span class="st">'collectAsMap'</span> to create a Key Value lookup</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>val movies <span class="op">=</span> sc.textFile(<span class="st">"/FileStore/tables/u.item"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Pluck out Movie ID <span class="kw">and</span> Movie Name <span class="kw">and</span> put into KV pair using collectAsMap()</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>val titles <span class="op">=</span> movies.<span class="bu">map</span>(line <span class="op">=&gt;</span> line.split(<span class="st">"</span><span class="ch">\\</span><span class="st">|"</span>).take(<span class="dv">2</span>)).<span class="bu">map</span>(array <span class="op">=&gt;</span> (array(<span class="dv">0</span>).toInt, array(<span class="dv">1</span>))).collectAsMap()</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> What <span class="kw">is</span> Movie title <span class="cf">for</span> Movie ID <span class="dv">180</span>  (Hint: A great war movie)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>println(titles(<span class="dv">180</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“e43c6c07-0ac6-411e-b107-7e9e2094a50a”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> What <span class="kw">is</span> Movie title <span class="cf">for</span> Movie ID <span class="dv">180</span>  (Hint: A great war movie)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>println(titles(<span class="dv">180</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“1015c5f3-b5dc-4b0e-b24d-f7a668a72ef7”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">1d</span>: Make Movie Recommendations <span class="cf">for</span> a specific User</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Generate Top <span class="dv">10</span> MovieID recommendation <span class="cf">for</span> User <span class="dv">2</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>val topKRecs <span class="op">=</span> model.recommendProducts(<span class="dv">2</span>,<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“8bd3709c-679d-4863-a2d4-4bd50a021456”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">1e</span>: Make Movie Name Recommendations <span class="cf">for</span> a specific User</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Generate Top <span class="dv">10</span> Movie Title recommendations <span class="cf">for</span> User <span class="dv">2</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>topKRecs.<span class="bu">map</span>(rating <span class="op">=&gt;</span> (titles(rating.product), rating.rating)).foreach(println)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-02-collaborative-filter---movie-recommendation-via-ml-spark-sql" class="level3">
<h3 class="anchored" data-anchor-id="lab-02-collaborative-filter---movie-recommendation-via-ml-spark-sql">Lab 02: Collaborative Filter - Movie Recommendation via ML (Spark SQL)</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“54331ea8-0998-48d1-8d14-731296a7e23a”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 02a: Load Data, Remove 'timestamp' column and Display</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>movieDF <span class="op">=</span> spark.read.csv(<span class="st">"/FileStore/tables/movielens_ratings.txt"</span>, header<span class="op">=</span><span class="va">True</span>, inferSchema<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>movieDF2 <span class="op">=</span> movieDF.drop(<span class="st">"timestamp"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>display(movieDF2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“a4c2db5d-d179-4626-813d-ae1cdf9e3f60”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 02b:  Split into TRAIN and </span><span class="al">TEST</span><span class="co"> DataFrames</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>(training, test) <span class="op">=</span> movieDF2.randomSplit([<span class="fl">0.8</span>, <span class="fl">0.2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“8552771f-faf7-4aac-8fd3-e77739483ebf”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 02c: Load Movie Name and remove excess Columns</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>nameDF <span class="op">=</span> spark.read.csv(<span class="st">"/FileStore/tables/movieid.txt"</span>, sep <span class="op">=</span> <span class="st">"|"</span>, header<span class="op">=</span><span class="va">True</span>, inferSchema<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>nameDF2 <span class="op">=</span> nameDF.drop(<span class="st">"dt"</span>).drop(<span class="st">"c0"</span>).drop(<span class="st">"c1"</span>).drop(<span class="st">"c2"</span>).drop(<span class="st">"c3"</span>).drop(<span class="st">"c4"</span>).drop(<span class="st">"c5"</span>).drop(<span class="st">"c5"</span>).drop(<span class="st">"c6"</span>).drop(<span class="st">"c7"</span>).drop(<span class="st">"c8"</span>).drop(<span class="st">"c9"</span>).drop(<span class="st">"c10"</span>)     .drop(<span class="st">"c11"</span>).drop(<span class="st">"c12"</span>).drop(<span class="st">"c13"</span>).drop(<span class="st">"c14"</span>).drop(<span class="st">"c15"</span>).drop(<span class="st">"c16"</span>).drop(<span class="st">"c17"</span>).drop(<span class="st">"c18"</span>).drop(<span class="st">"c19"</span>).drop(<span class="st">"url"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>display(nameDF2) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“ebb8f10c-2d91-4b78-8119-448469125e5d”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 02d: Build the recommendation model using ALS on the TRAIN data</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#          Note we set 'cold start strategy' to 'drop' to ensure we don't get NaN evaluation metrics</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.recommendation <span class="im">import</span> ALS</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>als <span class="op">=</span> ALS(maxIter<span class="op">=</span><span class="dv">5</span>, regParam<span class="op">=</span><span class="fl">0.01</span>, userCol<span class="op">=</span><span class="st">"user"</span>, itemCol<span class="op">=</span><span class="st">"id"</span>, ratingCol<span class="op">=</span><span class="st">"rating"</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>          coldStartStrategy<span class="op">=</span><span class="st">"drop"</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> als.fit(training)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“79176622-39e4-422f-8149-9f00d3a5bf98”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 02e: Generate top 10 Movie ID recommendations for a specified set of users (User 0,1,2)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>users <span class="op">=</span> movieDF2.select(als.getUserCol()).distinct().limit(<span class="dv">3</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>userSubsetRecs <span class="op">=</span> model.recommendForUserSubset(users, <span class="dv">10</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>display(userSubsetRecs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“ce671e3e-5ecd-4ed8-a07d-6aa327d91dc6”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 02f: To convert Movie ID to Movie Name, we first EXPLODE out the 'recommendations' column</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co">#          Now we have the value of the 'id' column</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> explode, col</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>nrecommendations <span class="op">=</span> userSubsetRecs<span class="op">\</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    .withColumn(<span class="st">"rec_exp"</span>, explode(<span class="st">"recommendations"</span>))<span class="op">\</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    .select(<span class="st">'user'</span>, col(<span class="st">"rec_exp.id"</span>), col(<span class="st">"rec_exp.rating"</span>))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>display(nrecommendations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“249562dd-1378-4acf-923e-a1872b339ae3”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 02g: Now JOIN nrecommendations to Movie Name dataframe (nameDF2) and see if Movie recommendations make sense</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>display(nrecommendations.join(nameDF2, on<span class="op">=</span><span class="st">'id'</span>).sort(<span class="st">'user'</span>,<span class="st">'rating'</span>, ascending<span class="op">=</span><span class="va">False</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-03-correlation---which-correlates-most-to-wins-hits-runs-home-runs-era" class="level3">
<h3 class="anchored" data-anchor-id="lab-03-correlation---which-correlates-most-to-wins-hits-runs-home-runs-era">Lab 03: Correlation - Which Correlates most to Wins? Hits, Runs, Home Runs, ERA?</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“c92920f8-6b05-4062-b304-fc9652e6842c”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 03a: Load Baseball data and Display</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>bbDF <span class="op">=</span> spark.read.csv(<span class="st">"/FileStore/tables/teams.csv"</span>, header<span class="op">=</span><span class="va">True</span>, inferSchema<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>display(bbDF)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“eac17fd6-2814-4bac-bac1-46d664cade09”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 03b: Which Correlates more to W(ins)?  (H)its, (R)uns, HR (Home Runs) or ERA?</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>bbDF.stat.corr(<span class="st">"w"</span>, <span class="st">"h"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“88d36a7e-b9a3-40ce-8204-26b1dc97217b”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 03b: Which Correlates more to W(ins)?  (H)its, (R)uns, HR (Home Runs) or ERA?</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>bbDF.stat.corr(<span class="st">"w"</span>, <span class="st">"r"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“7becb76e-e860-48eb-b5c8-4d01cad55261”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 03b: Which Correlates more to W(ins)?  (H)its, (R)uns, HR (Home Runs) or ERA?</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>bbDF.stat.corr(<span class="st">"w"</span>, <span class="st">"hr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“2b541136-93ae-411c-894d-94f77abbe502”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 03b: Which Correlates more to W(ins)?  (H)its, (R)uns, HR (Home Runs) or ERA?</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>bbDF.stat.corr(<span class="st">"w"</span>, <span class="st">"era"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-04-kmeans---divide-heart-patients-into-2-clusters" class="level3">
<h3 class="anchored" data-anchor-id="lab-04-kmeans---divide-heart-patients-into-2-clusters">Lab 04: KMeans - Divide Heart patients into 2 Clusters</h3>
<section id="the-classification-will-not-tell-us-which-have-heart-disease-thats-what-logistic-regression-did-in-the-previous-post" class="level4">
<h4 class="anchored" data-anchor-id="the-classification-will-not-tell-us-which-have-heart-disease-thats-what-logistic-regression-did-in-the-previous-post">The classification will not tell us which have heart disease (that’s what logistic regression did in the previous post),</h4>
</section>
<section id="but-you-can-logically-deduce-that-one-set-of-patients-is-sick-and-the-other-is-not-since-the-indicators-of-health-are-the-input-data" class="level4">
<h4 class="anchored" data-anchor-id="but-you-can-logically-deduce-that-one-set-of-patients-is-sick-and-the-other-is-not-since-the-indicators-of-health-are-the-input-data">but you can logically deduce that one set of patients is sick and the other is not, since the indicators of health are the input data</h4>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“fd0fa4a8-ecb4-40c1-918a-44225dfe9ca7”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 04a: Load Data</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Column 'thal' indicates if patient has heart problem:</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3 = Healthy</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6 = Repaired</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 7 = Needs Surgery</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>df1 <span class="op">=</span> spark.read.<span class="bu">format</span>(<span class="st">"csv"</span>).load(<span class="st">"dbfs:/FileStore/tables/heart1.csv"</span>,  inferSchema<span class="op">=</span><span class="st">"true"</span>, header<span class="op">=</span><span class="st">"true"</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>df1.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“c5d737ad-b616-4bff-8e0e-2600f1b80cef”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 04b: Assign X-variables to Vector</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorAssembler</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span>   (<span class="st">'age'</span>, <span class="st">'sex'</span>, <span class="st">'chest_pain'</span>, <span class="st">'bp'</span>, <span class="st">'chol'</span>, <span class="st">'sugar'</span>, <span class="st">'ecg'</span>, <span class="st">'maxhr'</span>,  </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>              <span class="st">'angina'</span>, <span class="st">'depress'</span>, <span class="st">'slope'</span>, <span class="st">'vessels'</span>) </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>assembler <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>features,outputCol<span class="op">=</span><span class="st">"features"</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>df3<span class="op">=</span>assembler.transform(df1)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>df3.select(<span class="st">"features"</span>).show(truncate<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“c432daa0-382d-461c-87aa-f1c60c96546f”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 04c: Run Means and produce 2 Clusters.  Then Evaluate</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.clustering <span class="im">import</span> KMeans</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Trains a K-means model for 2 Clusters</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>kmeans <span class="op">=</span> KMeans().setK(<span class="dv">2</span>).setSeed(<span class="dv">1</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> kmeans.fit(df3)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.transform(df3)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>predictions.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“096cfaaf-93ce-4ab2-abb7-5b9486b85ff1”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 04d: Evaluate Clusters for Euclidean Distance</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> ClusteringEvaluator</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate clustering by computing Euclidean Distance</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> ClusteringEvaluator()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>silhouette <span class="op">=</span> evaluator.evaluate(predictions)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Silhouette with squared euclidean distance = "</span> <span class="op">+</span> <span class="bu">str</span>(silhouette))</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Eculidean Distance. </span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># If NEG, data cannot be separated.  If 1, maximum separation</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># If 0, barely separated.  We got .57, which isn't bad</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Shows the result</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cluster Centers: "</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>ctr<span class="op">=</span>[]</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>centers <span class="op">=</span> model.clusterCenters()</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> center <span class="kw">in</span> centers:</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    ctr.append(center)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(center)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
</section>
<section id="lab-05" class="level3">
<h3 class="anchored" data-anchor-id="lab-05">Lab 05:</h3>
</section>
<section id="logistic-regression---goal-predict-purchase-based-on-gender-age-salary" class="level3">
<h3 class="anchored" data-anchor-id="logistic-regression---goal-predict-purchase-based-on-gender-age-salary">Logistic Regression - Goal: Predict Purchase based on Gender, Age, Salary</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“146cb862-ac58-4881-9f84-be327584dd5e”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">5a</span>:  Load DataFrame</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> https:<span class="op">//</span>medium.com<span class="op">/@</span>Sushil_Kumar<span class="op">/</span>machine<span class="op">-</span>learning<span class="op">-</span>pipelines<span class="op">-</span><span class="cf">with</span><span class="op">-</span>spark<span class="op">-</span>ml<span class="op">-</span><span class="dv">94</span><span class="er">cd9b4c973d</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>val advertDF <span class="op">=</span> spark.read.<span class="bu">format</span>(<span class="st">"csv"</span>).option(<span class="st">"header"</span>, <span class="st">"true"</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>              .option(<span class="st">"inferSchema"</span>, <span class="st">"true"</span>).load(<span class="st">"dbfs:/FileStore/tables/advert.csv"</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>display(advertDF)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“a625aaa0-99d9-4843-8ea3-321283c69f0a”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">5b</span>: Split DataFrame into <span class="dv">2</span> parts</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>val splits <span class="op">=</span> advertDF.randomSplit(Array(<span class="fl">0.8</span>, <span class="fl">0.2</span>), seed <span class="op">=</span> <span class="dv">1234L</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>val train <span class="op">=</span> splits(<span class="dv">0</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>val test <span class="op">=</span> splits(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“c3f9ff7f-2d0c-483b-a87f-aab5a3c6fb4a”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">5c</span>: Perform <span class="st">'OneHotEncoding'</span> to Convert Categorical <span class="st">'Gender'</span> column (String) into Numeric</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.apache.spark.ml.feature.OneHotEncoder</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.apache.spark.ml.feature.StringIndexer</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>val genderIndexer <span class="op">=</span> new StringIndexer().setInputCol(<span class="st">"Gender"</span>).setOutputCol(<span class="st">"GenderIndex"</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>val genderOneHotEncoder <span class="op">=</span> new OneHotEncoder().setInputCol(<span class="st">"GenderIndex"</span>).setOutputCol(<span class="st">"GenderOHE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“58708f9a-39d8-4585-ba99-548616cfcf22”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">5d</span>: Define X<span class="op">-</span>var Features (Gender, Age Salary) must be formated into Vector. </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="op">//</span>           Y<span class="op">-</span>var <span class="op">=</span> <span class="st">'Purchase'</span> colum</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="op">//</span>           Normalize data via Scaler (optional)                     </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.apache.spark.ml.feature.StandardScaler</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.apache.spark.ml.feature.VectorAssembler</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.apache.spark.ml.linalg.Vectors</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>val features <span class="op">=</span> Array(<span class="st">"GenderOHE"</span>, <span class="st">"Age"</span>, <span class="st">"EstimatedSalary"</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>val dependentVariable <span class="op">=</span> <span class="st">"Purchased"</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>val vectorAssembler <span class="op">=</span> new VectorAssembler().setInputCols(features).setOutputCol(<span class="st">"features"</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>val scaler <span class="op">=</span> new StandardScaler().setInputCol(<span class="st">"features"</span>).setOutputCol(<span class="st">"scaledFeatures"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“a46a457c-da8f-4ffd-bc73-39379f98a265”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">5e</span>: Tie Scaled Features (X<span class="op">-</span>var) to <span class="st">'Purchase'</span> (Y<span class="op">-</span>var) via Logistic Regression</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> This <span class="kw">is</span> our LabelPoint </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.apache.spark.ml.classification.LogisticRegression</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>val logisticRegression <span class="op">=</span> new LogisticRegression()</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  .setFeaturesCol(<span class="st">"scaledFeatures"</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  .setLabelCol(dependentVariable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“2158d2f8-b09f-423a-861c-70a55dc3adc1”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">5f</span>: Assemble the Pipeline</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.apache.spark.ml.{Pipeline, PipelineModel}</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>val stages <span class="op">=</span> Array(genderIndexer, genderOneHotEncoder, vectorAssembler, scaler, logisticRegression)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>val pipeline <span class="op">=</span> new Pipeline().setStages(stages)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Since will reiterate during Model creation, cache <span class="st">'train'</span> DataFrame</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>train.cache()</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Fit the Pipeline (Create Model using <span class="st">'train'</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>val model <span class="op">=</span> pipeline.fit(train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“94defa9c-7d7b-485a-b857-b22b8902f603”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">5g</span>: Using <span class="st">'model'</span>, make Prediction on <span class="st">'test'</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>val results <span class="op">=</span> model.transform(test)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>display(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“1f5d2443-9e58-4511-81b6-894c51301b90”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>scala</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Lab <span class="dv">0</span><span class="er">5h</span>: Calculate Model Accuracy</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.apache.spark.ml.evaluation.BinaryClassificationEvaluator</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>val evaluator <span class="op">=</span> new BinaryClassificationEvaluator()</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>      .setLabelCol(dependentVariable)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>      .setRawPredictionCol(<span class="st">"rawPrediction"</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>      .setMetricName(<span class="st">"areaUnderROC"</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>val accuracy <span class="op">=</span> evaluator.evaluate(results)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>println(s<span class="st">"Accuracy of Model : $</span><span class="sc">{accuracy}</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-06" class="level3">
<h3 class="anchored" data-anchor-id="lab-06">Lab 06</h3>
</section>
<section id="logistic-regression-again---goal-predict-income-50k-or-50k" class="level3">
<h3 class="anchored" data-anchor-id="logistic-regression-again---goal-predict-income-50k-or-50k">Logistic Regression again - Goal: Predict Income: &lt; $50k or &gt; $50k</h3>
<p>This tutorial is designed to get you started with Apache Spark MLlib. It investigates a binary classification problem - can you predict if an individual’s income is greater than $50,000 based on demographic data? The dataset is from the <a href="https://archive.ics.uci.edu/ml/datasets/Adult">UCI Machine Learning Repository</a> and is provided with Databricks Runtime. This notebook demonstrates some of the capabilities available in MLlib, including tools for data preprocessing, machine learning pipelines, and several different machine learning algorithms.</p>
<p>This notebook includes the following steps:</p>
<ol start="0" type="1">
<li>Load the dataset</li>
<li>Feature preprocessing</li>
<li>Define the model</li>
<li>Build the pipeline</li>
<li>Evaluate the model</li>
<li>Hyperparameter tuning</li>
<li>Make predictions and evaluate model performance</li>
</ol>
</section>
<section id="requirements" class="level2">
<h2 class="anchored" data-anchor-id="requirements">Requirements</h2>
<p>Databricks Runtime 7.0 or above or Databricks Runtime 7.0 ML or above. If you are running Databricks Runtime 6.x or Databricks Runtime 6.x ML, see (<a href="https://docs.databricks.com/getting-started/spark/machine-learning.html">AWS</a>|<a href="https://docs.microsoft.com/azure/databricks/getting-started/spark/machine-learning/">Azure</a>) for the correct notebook.</p>
</section>
<section id="step-1-load-the-data-into-schema-and-create-traintest.-then-examine-data" class="level2">
<h2 class="anchored" data-anchor-id="step-1-load-the-data-into-schema-and-create-traintest.-then-examine-data">Step 1: Load the Data into Schema and create TRAIN/TEST. Then examine data</h2>
<section id="lab-06a-view-file" class="level3">
<h3 class="anchored" data-anchor-id="lab-06a-view-file">Lab 06a: View file</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“a6427127-0bac-4d40-8920-9fb6aca6d118”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>fs head <span class="op">--</span>maxBytes<span class="op">=</span><span class="dv">1024</span> databricks<span class="op">-</span>datasets<span class="op">/</span>adult<span class="op">/</span>adult.data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-06b-create-a-schema-to-assign-column-names-and-datatypes" class="level3">
<h3 class="anchored" data-anchor-id="lab-06b-create-a-schema-to-assign-column-names-and-datatypes">Lab 06b: Create a Schema to assign column names and datatypes</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“90f1c445-4be5-453c-a510-e84a1d455743”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06b:</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>schema <span class="op">=</span> <span class="st">"""`age` DOUBLE,</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="st">`workclass` STRING,</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="st">`fnlwgt` DOUBLE,</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="st">`education` STRING,</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="st">`education_num` DOUBLE,</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="st">`marital_status` STRING,</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="st">`occupation` STRING,</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="st">`relationship` STRING,</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="st">`race` STRING,</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="st">`sex` STRING,</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="st">`capital_gain` DOUBLE,</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="st">`capital_loss` DOUBLE,</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="st">`hours_per_week` DOUBLE,</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="st">`native_country` STRING,</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="st">`income` STRING"""</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> spark.read.csv(<span class="st">"/databricks-datasets/adult/adult.data"</span>, schema<span class="op">=</span>schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-06c-randomly-split-data-into-training-and-test-sets-and-set-seed-for-reproducibility." class="level3">
<h3 class="anchored" data-anchor-id="lab-06c-randomly-split-data-into-training-and-test-sets-and-set-seed-for-reproducibility.">Lab 06c: Randomly split data into training and test sets, and set seed for reproducibility.</h3>
</section>
<section id="its-best-to-split-the-data-before-doing-any-preprocessing.-this-allows-the-test-dataset-to-more-closely-simulate-new-data-when-we-evaluate-the-model." class="level3">
<h3 class="anchored" data-anchor-id="its-best-to-split-the-data-before-doing-any-preprocessing.-this-allows-the-test-dataset-to-more-closely-simulate-new-data-when-we-evaluate-the-model.">It’s best to split the data before doing any preprocessing. This allows the test dataset to more closely simulate new data when we evaluate the model.</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“f576d5f9-8d43-4987-8e05-33e4392485e3”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06c:</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>trainDF, testDF <span class="op">=</span> dataset.randomSplit([<span class="fl">0.8</span>, <span class="fl">0.2</span>], seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(trainDF.cache().count()) <span class="co"># Cache because accessing training data multiple times</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(testDF.count())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-06d-lets-review-the-dataframe" class="level3">
<h3 class="anchored" data-anchor-id="lab-06d-lets-review-the-dataframe">Lab 06d: Let’s review the DataFrame</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“d2b9aafb-4061-4ad4-aa01-32a971852801”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06d:</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>trainDF.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-06e-whats-the-distribution-of-the-number-of-hours_per_week" class="level3">
<h3 class="anchored" data-anchor-id="lab-06e-whats-the-distribution-of-the-number-of-hours_per_week">Lab 06e: What’s the distribution of the number of <code>hours_per_week</code>?</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“8493515c-7e45-4f19-88e3-64a4605a8fdd”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06e:</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>display(trainDF.select(<span class="st">"hours_per_week"</span>).summary())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-06f-how-about-education-status" class="level3">
<h3 class="anchored" data-anchor-id="lab-06f-how-about-education-status">Lab 06f: How about <code>education</code> status?</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“8b72f3c1-56a2-4014-9059-51cea03bc9e7”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06f:</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>display(trainDF</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>        .groupBy(<span class="st">"education"</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>        .count()</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        .sort(<span class="st">"count"</span>, ascending<span class="op">=</span><span class="va">False</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
</section>
<section id="background-transformers-estimators-and-pipelines" class="level2">
<h2 class="anchored" data-anchor-id="background-transformers-estimators-and-pipelines">Background: Transformers, Estimators, and Pipelines</h2>
<p>Three important concepts in MLlib machine learning that are illustrated in this notebook are <strong>Transformers</strong>, <strong>Estimators</strong>, and <strong>Pipelines</strong>.</p>
<ul>
<li><p><strong>Transformer</strong>: Takes a DataFrame as input, and returns a new DataFrame. Transformers do not learn any parameters from the data and simply apply rule-based transformations to either prepare data for model training or generate predictions using a trained MLlib model. You call a transformer with a <code>.transform()</code> method.</p></li>
<li><p><strong>Estimator</strong>: Learns (or “fits”) parameters from your DataFrame via a <code>.fit()</code> method and returns a Model, which is a transformer.</p></li>
<li><p><strong>Pipeline</strong>: Combines multiple steps into a single workflow that can be easily run. Creating a machine learning model typically involves setting up many different steps and iterating over them. Pipelines help you automate this process.</p></li>
</ul>
<p>For more information: <a href="https://spark.apache.org/docs/latest/ml-pipeline.html#ml-pipelines">ML Pipelines</a></p>
</section>
<section id="step-2.-feature-engineering-preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="step-2.-feature-engineering-preprocessing">Step 2. Feature Engineering (Preprocessing)</h2>
<p>The goal of this notebook is to build a model that predicts the <code>income</code> level from the features included in the dataset (education level, marital status, occupation, and so on). The first step is to manipulate, or preprocess, the features so they are in the format MLlib requires.</p>
<section id="lab-06g-convert-categorical-variables-to-numeric" class="level3">
<h3 class="anchored" data-anchor-id="lab-06g-convert-categorical-variables-to-numeric">Lab 06g: Convert categorical variables to numeric</h3>
<p>Some machine learning algorithms, such as linear and logistic regression, require numeric features. The Adult dataset includes categorical features such as education, occupation, and marital status.</p>
<p>The following code block illustrates how to use <code>StringIndexer</code> and <code>OneHotEncoder</code> to convert categorical variables into a set of numeric variables that only take on values 0 and 1.</p>
<ul>
<li><code>StringIndexer</code> converts a column of string values to a column of label indexes. For example, it might convert the values “red”, “blue”, and “green” to 0, 1, and 2.</li>
<li><code>OneHotEncoder</code> maps a column of category indices to a column of binary vectors, with at most one “1” in each row that indicates the category index for that row.</li>
</ul>
<p>One-hot encoding in Spark is a two-step process. You first use the StringIndexer, followed by the OneHotEncoder. The following code block defines the StringIndexer and OneHotEncoder but does not apply it to any data yet.</p>
<p>For more information:<br>
<a href="http://spark.apache.org/docs/latest/ml-features.html#stringindexer">StringIndexer</a><br>
<a href="https://spark.apache.org/docs/latest/ml-features.html#onehotencoder">OneHotEncoder</a></p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“36016457-5fda-4142-a603-da869beba282”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06g:</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> StringIndexer, OneHotEncoder</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>categoricalCols <span class="op">=</span> [<span class="st">"workclass"</span>, <span class="st">"education"</span>, <span class="st">"marital_status"</span>, <span class="st">"occupation"</span>, <span class="st">"relationship"</span>, <span class="st">"race"</span>, <span class="st">"sex"</span>]</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The following two lines are estimators. They return functions that we will later apply to transform the dataset.</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>stringIndexer <span class="op">=</span> StringIndexer(inputCols<span class="op">=</span>categoricalCols, outputCols<span class="op">=</span>[x <span class="op">+</span> <span class="st">"Index"</span> <span class="cf">for</span> x <span class="kw">in</span> categoricalCols]) </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>encoder <span class="op">=</span> OneHotEncoder(inputCols<span class="op">=</span>stringIndexer.getOutputCols(), outputCols<span class="op">=</span>[x <span class="op">+</span> <span class="st">"OHE"</span> <span class="cf">for</span> x <span class="kw">in</span> categoricalCols]) </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co"># The label column ("income") is also a string value - it has two possible values, "&lt;=50K" and "&gt;50K". </span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert it to a numeric value using StringIndexer.</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>labelToIndex <span class="op">=</span> StringIndexer(inputCol<span class="op">=</span><span class="st">"income"</span>, outputCol<span class="op">=</span><span class="st">"label"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-06h-in-this-notebook-well-build-a-pipeline-combining-all-of-our-feature-engineering-and-modeling-steps.-but-lets-take-a-minute-to-look-more-closely-at-how-estimators-and-transformers-work-by-applying-the-stringindexer-estimator-that-we-created-in-the-previous-code-block." class="level3">
<h3 class="anchored" data-anchor-id="lab-06h-in-this-notebook-well-build-a-pipeline-combining-all-of-our-feature-engineering-and-modeling-steps.-but-lets-take-a-minute-to-look-more-closely-at-how-estimators-and-transformers-work-by-applying-the-stringindexer-estimator-that-we-created-in-the-previous-code-block.">Lab 06h: In this notebook, we’ll build a pipeline combining all of our feature engineering and modeling steps. But let’s take a minute to look more closely at how estimators and transformers work by applying the <code>stringIndexer</code> estimator that we created in the previous code block.</h3>
<p>You can call the <code>.fit()</code> method to return a <code>StringIndexerModel</code>, which you can then use to transform the dataset.</p>
<p>The <code>.transform()</code> method of <code>StringIndexerModel</code> returns a new DataFrame with the new columns appended. Scroll right to see the new columns</p>
<p>For more information: <a href="https://spark.apache.org/docs/latest/api/java/org/apache/spark/ml/feature/StringIndexerModel.html">StringIndexerModel</a></p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“f7b352d2-659e-4b32-983f-168d61e4cc66”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06h:</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>stringIndexerModel <span class="op">=</span> stringIndexer.fit(trainDF)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>display(stringIndexerModel.transform(trainDF))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-06i-combine-all-feature-columns-into-a-single-feature-vector" class="level3">
<h3 class="anchored" data-anchor-id="lab-06i-combine-all-feature-columns-into-a-single-feature-vector">Lab 06i: Combine all feature columns into a single feature vector</h3>
<p>Most MLlib algorithms require a single features column as input. Each row in this column contains a vector of data points corresponding to the set of features used for prediction.</p>
<p>MLlib provides the <code>VectorAssembler</code> transformer to create a single vector column from a list of columns.</p>
<p>The following code block illustrates how to use VectorAssembler.</p>
<p>For more information: <a href="https://spark.apache.org/docs/latest/ml-features.html#vectorassembler">VectorAssembler</a></p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“4620dd22-e738-405e-938a-e588eff880f7”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06i:</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorAssembler</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This includes both the numeric columns and the one-hot encoded binary vector columns in our dataset.</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>numericCols <span class="op">=</span> [<span class="st">"age"</span>, <span class="st">"fnlwgt"</span>, <span class="st">"education_num"</span>, <span class="st">"capital_gain"</span>, <span class="st">"capital_loss"</span>, <span class="st">"hours_per_week"</span>]</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>assemblerInputs <span class="op">=</span> [c <span class="op">+</span> <span class="st">"OHE"</span> <span class="cf">for</span> c <span class="kw">in</span> categoricalCols] <span class="op">+</span> numericCols</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>vecAssembler <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>assemblerInputs, outputCol<span class="op">=</span><span class="st">"features"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
</section>
<section id="step-3.-lab-06j-define-the-model" class="level2">
<h2 class="anchored" data-anchor-id="step-3.-lab-06j-define-the-model">Step 3. Lab 06j: Define the Model</h2>
<p>This notebook uses a <a href="https://spark.apache.org/docs/latest/ml-classification-regression.html#logistic-regression">logistic regression</a> model.</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“50e68afb-920f-4858-b629-a96bd7b8efc3”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06j:</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.classification <span class="im">import</span> LogisticRegression</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> LogisticRegression(featuresCol<span class="op">=</span><span class="st">"features"</span>, labelCol<span class="op">=</span><span class="st">"label"</span>, regParam<span class="op">=</span><span class="fl">1.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="step-4.-lab-06k-build-the-pipeline-and-score-model-via-test" class="level2">
<h2 class="anchored" data-anchor-id="step-4.-lab-06k-build-the-pipeline-and-score-model-via-test">Step 4. Lab 06k: Build the Pipeline and Score Model via TEST</h2>
<p>A <code>Pipeline</code> is an ordered list of transformers and estimators. You can define a pipeline to automate and ensure repeatability of the transformations to be applied to a dataset. In this step, we define the pipeline and then apply it to the test dataset.</p>
<p>Similar to what we saw with <code>StringIndexer</code>, a <code>Pipeline</code> is an estimator. The <code>pipeline.fit()</code> method returns a <code>PipelineModel</code>, which is a transformer.</p>
<p>For more information:<br>
<a href="https://spark.apache.org/docs/latest/api/python/pyspark.ml.html#pyspark.ml.Pipeline">Pipeline</a><br>
<a href="https://spark.apache.org/docs/latest/api/java/org/apache/spark/ml/PipelineModel.html">PipelineModel</a></p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“add42595-50c2-4230-88f8-b9663311aa7b”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06k:</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> Pipeline</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the pipeline based on the stages created in previous steps.</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(stages<span class="op">=</span>[stringIndexer, encoder, labelToIndex, vecAssembler, lr])</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the pipeline Model on TRAIN dataset</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>pipelineModel <span class="op">=</span> pipeline.fit(trainDF)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the pipeline Model to the </span><span class="al">TEST</span><span class="co"> dataset.</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>predDF <span class="op">=</span> pipelineModel.transform(testDF)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<section id="lab-06l-display-the-predictions-from-the-model.-the-features-column-is-a-sparse-vector-which-is-often-the-case-after-one-hot-encoding-because-there-are-so-many-0-values." class="level3">
<h3 class="anchored" data-anchor-id="lab-06l-display-the-predictions-from-the-model.-the-features-column-is-a-sparse-vector-which-is-often-the-case-after-one-hot-encoding-because-there-are-so-many-0-values.">Lab 06l: Display the predictions from the Model. The <code>features</code> column is a <a href="https://spark.apache.org/docs/latest/api/python/pyspark.ml.html#pyspark.ml.linalg.SparseVector">sparse vector</a>, which is often the case after one-hot encoding, because there are so many 0 values.</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“89253746-407e-4652-9104-d7a85b330897”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06l: Diplay Prediction</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>display(predDF.select(<span class="st">"features"</span>, <span class="st">"label"</span>, <span class="st">"prediction"</span>, <span class="st">"probability"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
</section>
<section id="step-5.-lab-06m-evaluate-the-model-using-roc" class="level2">
<h2 class="anchored" data-anchor-id="step-5.-lab-06m-evaluate-the-model-using-roc">Step 5. Lab 06m: Evaluate the Model using ROC</h2>
<p>The <code>display</code> command has a built-in ROC curve option.</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“0c14326d-36d2-4940-98cf-ed26e780c42b”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06m:</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>display(pipelineModel.stages[<span class="op">-</span><span class="dv">1</span>], predDF.drop(<span class="st">"prediction"</span>, <span class="st">"rawPrediction"</span>, <span class="st">"probability"</span>), <span class="st">"ROC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>To evaluate the model, we use the <code>BinaryClassificationEvaluator</code> to evalute the area under the ROC curve and the <code>MulticlassClassificationEvaluator</code> to evalute the accuracy.</p>
<p>For more information:<br>
<a href="https://spark.apache.org/docs/latest/api/python/pyspark.ml.html#pyspark.ml.evaluation.BinaryClassificationEvaluator">BinaryClassificationEvaluator</a><br>
<a href="https://spark.apache.org/docs/latest/api/python/pyspark.ml.html#pyspark.ml.evaluation.MulticlassClassificationEvaluator">MulticlassClassificationEvaluator</a></p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“7a052ca4-94e0-4b54-b8f6-c9a089c41b6e”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06n:</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> BinaryClassificationEvaluator, MulticlassClassificationEvaluator</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>bcEvaluator <span class="op">=</span> BinaryClassificationEvaluator(metricName<span class="op">=</span><span class="st">"areaUnderROC"</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Area under ROC curve: </span><span class="sc">{</span>bcEvaluator<span class="sc">.</span>evaluate(predDF)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>mcEvaluator <span class="op">=</span> MulticlassClassificationEvaluator(metricName<span class="op">=</span><span class="st">"accuracy"</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Accuracy: </span><span class="sc">{</span>mcEvaluator<span class="sc">.</span>evaluate(predDF)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="step-6.-hyperparameter-tuning" class="level2">
<h2 class="anchored" data-anchor-id="step-6.-hyperparameter-tuning">Step 6. Hyperparameter tuning</h2>
<p>MLlib provides methods to facilitate hyperparameter tuning and cross validation. - For hyperparameter tuning, <code>ParamGridBuilder</code> lets you define a grid search over a set of model hyperparameters. - For cross validation, <code>CrossValidator</code> lets you specify an estimator (the pipeline to apply to the input dataset), an evaluator, a grid space of hyperparameters, and the number of folds to use for cross validation.</p>
<p>For more information:<br>
<a href="https://spark.apache.org/docs/latest/ml-tuning.html">Model selection using cross-validation</a><br>
<a href="https://spark.apache.org/docs/latest/api/python/pyspark.ml.html#module-pyspark.ml.tuning">ParamGridBuilder</a><br>
<a href="https://spark.apache.org/docs/latest/api/python/pyspark.ml.html#pyspark.ml.tuning.CrossValidator">CrossValidator</a></p>
<p>Use <code>ParamGridBuilder</code> and <code>CrossValidator</code> to tune the model. This example uses three values for <code>regParam</code> and three for <code>elasticNetParam</code>, for a total of 3 x 3 = 9 hyperparameter combinations for <code>CrossValidator</code> to examine.</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“5a2f8b20-7974-47fb-a5c5-4391967877d4”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06o</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.tuning <span class="im">import</span> ParamGridBuilder, CrossValidator</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>paramGrid <span class="op">=</span> (ParamGridBuilder()</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>             .addGrid(lr.regParam, [<span class="fl">0.01</span>, <span class="fl">0.5</span>, <span class="fl">2.0</span>])</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>             .addGrid(lr.elasticNetParam, [<span class="fl">0.0</span>, <span class="fl">0.5</span>, <span class="fl">1.0</span>])</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>             .build())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>Whenever you call <code>CrossValidator</code> in MLlib, Databricks automatically tracks all of the runs using <a href="https://mlflow.org/">MLflow</a>. You can use the MLflow UI (<a href="https://docs.databricks.com/applications/mlflow/index.html">AWS</a>|<a href="https://docs.microsoft.com/azure/databricks/applications/mlflow/">Azure</a>) to compare how each model performed.</p>
<p>In this example we use the pipeline we created as the estimator.</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“ff7a7e57-b2c0-4ff8-b8c3-8c02a0765e7c”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">WARNING</span><span class="co">: This query take about 5-10 minutes to Execute</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06p: Create a 3-fold CrossValidator</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> CrossValidator(estimator<span class="op">=</span>pipeline, estimatorParamMaps<span class="op">=</span>paramGrid, evaluator<span class="op">=</span>bcEvaluator, numFolds<span class="op">=</span><span class="dv">3</span>, parallelism <span class="op">=</span> <span class="dv">4</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Run cross validations. This step takes a few minutes and returns the best model found from the cross validation.</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>cvModel <span class="op">=</span> cv.fit(trainDF)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="step-7." class="level2">
<h2 class="anchored" data-anchor-id="step-7.">Step 7.</h2>
<p>###Lab 06q: Make predictions and evaluate model performance ###Use the best Model identified by the Cross-Validation to make predictions on the test dataset, and then evaluate the model’s performance using the area under the ROC curve.</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“121f5db1-909a-464d-b8f6-b32fe9bcaecb”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06q: Use the model identified by the cross-validation to make predictions on the </span><span class="al">TEST</span><span class="co"> dataset</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>cvPredDF <span class="op">=</span> cvModel.transform(testDF)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate the model's performance based on area under the ROC curve and accuracy </span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Area under ROC curve: </span><span class="sc">{</span>bcEvaluator<span class="sc">.</span>evaluate(cvPredDF)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Accuracy: </span><span class="sc">{</span>mcEvaluator<span class="sc">.</span>evaluate(cvPredDF)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>Using SQL commands, you can also display predictions grouped by age and occupation. This requires creating a temporary view of the predictions dataset.</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“49bf7fc7-69af-4abb-a51a-b2d73e0741e7”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 06r:</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>cvPredDF.createOrReplaceTempView(<span class="st">"finalPredictions"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“707f274b-6cdc-45c8-ae2c-27c68e9c94a1”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>sql</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="op">--</span> Lab <span class="dv">0</span><span class="er">6s</span>:</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>SELECT occupation, prediction, count(<span class="op">*</span>) AS count</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>FROM finalPredictions</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>GROUP BY occupation, prediction</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>ORDER BY occupation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“83943d19-15df-4ec0-a937-f6eb7f6e2fa6”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>sql</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="op">--</span> Lab <span class="dv">0</span><span class="er">6t</span>:</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>SELECT age, prediction, count(<span class="op">*</span>) AS count</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>FROM finalPredictions</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>GROUP BY age, prediction</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>ORDER BY age</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<section id="lab-07" class="level3">
<h3 class="anchored" data-anchor-id="lab-07">Lab 07:</h3>
</section>
<section id="goal-predict-bike-rental-counts-per-hour-using-gradient-boost-trees-regression" class="level3">
<h3 class="anchored" data-anchor-id="goal-predict-bike-rental-counts-per-hour-using-gradient-boost-trees-regression">Goal: Predict Bike rental counts (per hour) using Gradient Boost Trees Regression</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“9fe486b7-b548-4317-b24e-8dbf8d757500”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07a: Load Data</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>bikeDF <span class="op">=</span> spark.read.csv(<span class="st">"/FileStore/tables/hour.csv"</span>, header<span class="op">=</span><span class="va">True</span>, inferSchema<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>bikeDF.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“15ef3508-aebc-4f8f-a7b6-bf0dfcc7c78d”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07b: Remove Columns not needed for Prediction</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>bikeDF2 <span class="op">=</span> bikeDF.drop(<span class="st">"instant"</span>).drop(<span class="st">"dteday"</span>).drop(<span class="st">"casual"</span>).drop(<span class="st">"registered"</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>bikeDF2.show(<span class="dv">5</span>)   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“d0ddb697-5c42-4204-be8b-12f6b0c164a6”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07c: Change all Data types to Double</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> col</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>bikeDF2.printSchema()</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>bikeDF3 <span class="op">=</span> bikeDF2.select([col(c).cast(<span class="st">"double"</span>).alias(c) <span class="cf">for</span> c <span class="kw">in</span> bikeDF2.columns])</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>bikeDF3.printSchema()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“c64db0f9-100f-43ca-a9ad-506a093f106e”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07d: Visualize</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Line Chart: In Plot options, Key = hr, Values = cnt</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>display(bikeDF3.select (<span class="st">"hr"</span>, <span class="st">"cnt"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“f09350d4-62ce-4558-8f6f-d8b260b75b75”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07e: Create TRAIN and </span><span class="al">TEST</span><span class="co"> DataFrames</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>train, test <span class="op">=</span> bikeDF3.randomSplit([<span class="fl">0.7</span>, <span class="fl">0.3</span>])</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co">"We have %d TRAIN and %d </span><span class="al">TEST</span><span class="co"> rows."</span> <span class="op">%</span> (train.count(), test.count())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“6259e2b5-99ac-4250-a669-437f55b36ee6”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07f: Define Feature Pipeline</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorAssembler, VectorIndexer</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>featuresCols <span class="op">=</span> bikeDF3.columns</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>featuresCols.remove(<span class="st">'cnt'</span>)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co"># // This concatenates all feature columns into a single feature vector in a new column "rawFeatures"</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>vectorAssembler <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>featuresCols, outputCol<span class="op">=</span><span class="st">"rawFeatures"</span>)</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co"># // This identifies categorical features and indexes them.</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>vectorIndexer <span class="op">=</span> VectorIndexer(inputCol<span class="op">=</span><span class="st">"rawFeatures"</span>, outputCol<span class="op">=</span><span class="st">"features"</span>, maxCategories<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“970d96eb-7699-4ba7-9503-c3cecaa13b8f”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07g: Define Y-var column for GBTRegressor</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> GBTRegressor</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Takes the "features" column and learns to predict "cnt"</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>gbt <span class="op">=</span> GBTRegressor(labelCol<span class="op">=</span><span class="st">"cnt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“85dd5ae4-4011-467c-9e3b-1919c3f84ba6”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07h: Add Cross Validation to Pipeline</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This will help determine best parameters to enter for better Model Accuracy</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.tuning <span class="im">import</span> CrossValidator, ParamGridBuilder</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co">#// Define a grid of hyperparameters to test:</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co">#//  - maxDepth: max depth of each decision tree in the GBT ensemble</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="co">#//  - maxIter: iterations, i.e., number of trees in each GBT ensemble</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="co">#// In this example, we keep these values small.  In practice, to get the highest accuracy, you would likely </span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="co">#// want to try deeper trees (10 or higher) and more trees in the ensemble (&gt;100).</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>paramGrid <span class="op">=</span> ParamGridBuilder().addGrid(gbt.maxDepth, [<span class="dv">2</span>, <span class="dv">5</span>]).addGrid(gbt.maxIter, [<span class="dv">5</span>, <span class="dv">50</span>]).build()</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a><span class="co"># We define evaluation metric.  This tells CrossValidator how well we are doing by comparing true labels with predictions.</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> RegressionEvaluator(metricName<span class="op">=</span><span class="st">"rmse"</span>, labelCol<span class="op">=</span>gbt.getLabelCol(), predictionCol<span class="op">=</span>gbt.getPredictionCol())</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Declare the CrossValidator, which runs model tuning for us.</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> CrossValidator(estimator<span class="op">=</span>gbt, evaluator<span class="op">=</span>evaluator, estimatorParamMaps<span class="op">=</span>paramGrid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“6a5629b2-bac7-4f04-a781-6e33a84e66e4”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07i: Tie Feature Processing/Model training stages together into single Pipeline</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> Pipeline</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(stages<span class="op">=</span>[vectorAssembler, vectorIndexer, cv])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“99f72cc9-07a9-4c4c-9bda-622f5820b6e9”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07j: Create Model (takes 6-7 minutes to run)</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>train.cache()</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This takes a while to run</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>pipelineModel <span class="op">=</span> pipeline.fit(train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“a388777b-20a4-41b6-8c77-6324cecb3a82”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07k: Score Model on </span><span class="al">TEST</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> pipelineModel.transform(test)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>predictions.select(<span class="st">"cnt"</span>, <span class="st">"prediction"</span>, <span class="op">*</span>featuresCols).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“1dd4d96d-8b0b-4eed-8392-4d2c53dfdb59”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 07l: Visualize the Prediction</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="co"># In Plot options, Key = hr, Values = cnt</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Line Chart: In Plot options, Key = hr, Values = cnt</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># If it looks similar to earlier Chart, Accuracy is good</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>display(predictions.select (<span class="st">"hr"</span>, <span class="st">"cnt"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-08-predict-titanic-survive-not-survive-using-decision-tree" class="level3">
<h3 class="anchored" data-anchor-id="lab-08-predict-titanic-survive-not-survive-using-decision-tree">Lab 08: Predict Titanic Survive, Not Survive using Decision Tree</h3>
<section id="httpsdatabricks-prod-cloudfront.cloud.databricks.compublic4027ec902e239c93eaaa8714f173bcfc572219029079598938655951670343688175309257345795latest.html" class="level4">
<h4 class="anchored" data-anchor-id="httpsdatabricks-prod-cloudfront.cloud.databricks.compublic4027ec902e239c93eaaa8714f173bcfc572219029079598938655951670343688175309257345795latest.html">https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/5722190290795989/3865595167034368/8175309257345795/latest.html</h4>
</section>
</section>
<section id="lab-08a-load-libraries-and-loadview-dataframe" class="level3">
<h3 class="anchored" data-anchor-id="lab-08a-load-libraries-and-loadview-dataframe">Lab 08a: Load Libraries and Load/View DataFrame</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“c54ac2fd-8552-413f-9b0b-b5e9b45c6be6”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08a:</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> Pipeline</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> mean,col,split, col, regexp_extract, when, lit</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> StringIndexer</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorAssembler</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> MulticlassClassificationEvaluator</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> QuantileDiscretizer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“ca858943-d08c-417b-8353-cb8c143a561f”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08a:</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> spark.read.csv(<span class="st">"/FileStore/tables/titanic_master.txt"</span>, sep <span class="op">=</span> <span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header <span class="op">=</span> <span class="st">'True'</span>,inferSchema<span class="op">=</span><span class="st">'True'</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>display(titanic_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-08b-view-data-statistics" class="level3">
<h3 class="anchored" data-anchor-id="lab-08b-view-data-statistics">Lab 08b: View Data Statistics</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“057039a9-fabf-42f8-9598-8a889862f6e7”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08b: Out of 891 passengers in dataset, only about 342 survived</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>groupBy_output <span class="op">=</span> titanic_df.groupBy(<span class="st">"Survived"</span>).count()</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>display(groupBy_output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“c68edc4e-fcf2-4115-b9a1-0fd34d5e8592”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08b: Although the number of males are more than females on ship, the female survivors are twice the number of males saved.</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>titanic_df.groupBy(<span class="st">"Gender"</span>,<span class="st">"Survived"</span>).count().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“6e820187-63a5-4fa3-942b-b7e6985b54df”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08b: 1st Class had good Survival rate, 3rd Class not so good</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>titanic_df.groupBy(<span class="st">"Pclass"</span>,<span class="st">"Survived"</span>).count().orderBy(<span class="st">"Pclass"</span>, <span class="st">"Survived"</span>).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-08c-clean-the-data" class="level3">
<h3 class="anchored" data-anchor-id="lab-08c-clean-the-data">Lab 08c: Clean the Data</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“a86ff2ca-a9bc-4717-a486-62078d9ca583”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08c: This function finds NULLs</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> null_value_count(df):</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  null_columns_counts <span class="op">=</span> []</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  numRows <span class="op">=</span> df.count()</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> k <span class="kw">in</span> df.columns:</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    nullRows <span class="op">=</span> df.where(col(k).isNull()).count()</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(nullRows <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>      temp <span class="op">=</span> k,nullRows</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>      null_columns_counts.append(temp)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span>(null_columns_counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“9eacfdaa-daa6-4842-a740-ae69f7133277”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08c: Calling function</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>null_columns_count_list <span class="op">=</span> null_value_count(titanic_df)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>spark.createDataFrame(null_columns_count_list, [<span class="st">'Column_With_Null_Value'</span>, <span class="st">'Null_Values_Count'</span>]).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“84889e68-3d27-466c-a3bb-117bfde7d427”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08c: Find mean Age</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>mean_age <span class="op">=</span> titanic_df.select(mean(<span class="st">'Age'</span>)).collect()</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>display(mean_age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“316e458b-0ef0-4317-8fd6-d55ede32f45b”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08c: To replace these NaN values, we can assign them the mean age of the dataset.But the problem is, there were many people with many different #ages. We just cant assign a 4 year kid with the mean age that is 29 years. </span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we can check the Name feature. Looking upon the feature, we can see that the names have a salutation like Mr or Mrs. Thus we can assign the mean #values of Mr and Mrs to the respective groups</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the Regex ""[A-Za-z]+)." we extract the initials from the Name. It looks for strings which lie between A-Z or a-z and followed by a .(dot).</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.withColumn(<span class="st">"Initial"</span>,regexp_extract(col(<span class="st">"Name"</span>),<span class="st">"([A-Za-z]+)\."</span>,<span class="dv">1</span>))</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>titanic_df.select(<span class="st">"Initial"</span>).distinct().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“bef67437-08e0-4ab9-b145-ca656de83e72”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08c: There are some misspelled Initials like Mlle or Mme that stand for Miss. I will replace them with Miss and same thing for other values.</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.replace([<span class="st">'Mlle'</span>,<span class="st">'Mme'</span>, <span class="st">'Ms'</span>, <span class="st">'Dr'</span>,<span class="st">'Major'</span>,<span class="st">'Lady'</span>,<span class="st">'Countess'</span>,<span class="st">'Jonkheer'</span>,<span class="st">'Col'</span>,<span class="st">'Rev'</span>,<span class="st">'Capt'</span>,<span class="st">'Sir'</span>,<span class="st">'Don'</span>],</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>               [<span class="st">'Miss'</span>,<span class="st">'Miss'</span>,<span class="st">'Miss'</span>,<span class="st">'Mr'</span>,<span class="st">'Mr'</span>,  <span class="st">'Mrs'</span>,  <span class="st">'Mrs'</span>,  <span class="st">'Other'</span>,  <span class="st">'Other'</span>,<span class="st">'Other'</span>,<span class="st">'Mr'</span>,<span class="st">'Mr'</span>,<span class="st">'Mr'</span>])</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>titanic_df.select(<span class="st">"Initial"</span>).distinct().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“6b2a8774-c6f1-47ac-b34b-96005df204ce”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08c: Lets check the average Age by Initials</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>titanic_df.groupby(<span class="st">'Initial'</span>).avg(<span class="st">'Age'</span>).collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“382d7fd1-38d8-4e83-a223-f91ee7015441”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08c: Let's calcualte missing values in Age feature based on average age of Initials</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.withColumn(<span class="st">"Age"</span>,when((titanic_df[<span class="st">"Initial"</span>] <span class="op">==</span> <span class="st">"Miss"</span>) <span class="op">&amp;</span> (titanic_df[<span class="st">"Age"</span>].isNull()), <span class="dv">22</span>).otherwise(titanic_df[<span class="st">"Age"</span>]))</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.withColumn(<span class="st">"Age"</span>,when((titanic_df[<span class="st">"Initial"</span>] <span class="op">==</span> <span class="st">"Other"</span>) <span class="op">&amp;</span> (titanic_df[<span class="st">"Age"</span>].isNull()), <span class="dv">46</span>).otherwise(titanic_df[<span class="st">"Age"</span>]))</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.withColumn(<span class="st">"Age"</span>,when((titanic_df[<span class="st">"Initial"</span>] <span class="op">==</span> <span class="st">"Master"</span>) <span class="op">&amp;</span> (titanic_df[<span class="st">"Age"</span>].isNull()), <span class="dv">5</span>).otherwise(titanic_df[<span class="st">"Age"</span>]))</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.withColumn(<span class="st">"Age"</span>,when((titanic_df[<span class="st">"Initial"</span>] <span class="op">==</span> <span class="st">"Mr"</span>) <span class="op">&amp;</span> (titanic_df[<span class="st">"Age"</span>].isNull()), <span class="dv">33</span>).otherwise(titanic_df[<span class="st">"Age"</span>]))</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.withColumn(<span class="st">"Age"</span>,when((titanic_df[<span class="st">"Initial"</span>] <span class="op">==</span> <span class="st">"Mrs"</span>) <span class="op">&amp;</span> (titanic_df[<span class="st">"Age"</span>].isNull()), <span class="dv">36</span>).otherwise(titanic_df[<span class="st">"Age"</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“cddfac79-e194-4e27-b5e7-cc830d64ae02”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08c: Majority Passengers boarded from "S". We can assign with "S"</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>titanic_df.groupBy(<span class="st">"Embarked"</span>).count().show()</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.na.fill({<span class="st">"Embarked"</span> : <span class="st">'S'</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“c8c656a6-b7db-4c89-a2ac-e24aaaa670f4”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08c: We can drop Cabin features as it has lots of NULL values</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.drop(<span class="st">"Cabin"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“01d8ee18-4edf-4b6d-b3d7-3b23f1ca6ce0”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08c: We can create a new feature called "Family_size" and "Alone" and analyse it. This feature is the summation of Parch(parents/children) and #SibSp(siblings/spouses). It gives us a combined data so that we can check if survival rate have anything to do with family size of the passengers</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.withColumn(<span class="st">"Family_Size"</span>,col(<span class="st">'SibSp'</span>)<span class="op">+</span>col(<span class="st">'Parch'</span>))</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.withColumn(<span class="st">'Alone'</span>,lit(<span class="dv">0</span>))</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.withColumn(<span class="st">"Alone"</span>,when(titanic_df[<span class="st">"Family_Size"</span>] <span class="op">==</span> <span class="dv">0</span>, <span class="dv">1</span>).otherwise(titanic_df[<span class="st">"Alone"</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-08d-convert-categorical-to-numeic-and-then-pipeline-and-transform.-then-view" class="level3">
<h3 class="anchored" data-anchor-id="lab-08d-convert-categorical-to-numeic-and-then-pipeline-and-transform.-then-view">Lab 08d: Convert Categorical to Numeic and then Pipeline and Transform. Then View</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“1f414605-7ca3-4c79-af1b-53c67a9ab4b5”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08d: Lets convert Gender, Embarked &amp; Initial columns from string to number using StringIndexer</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>indexers <span class="op">=</span> [StringIndexer(inputCol<span class="op">=</span>column, outputCol<span class="op">=</span>column<span class="op">+</span><span class="st">"_index"</span>).fit(titanic_df) <span class="cf">for</span> column <span class="kw">in</span> [<span class="st">"Gender"</span>,<span class="st">"Embarked"</span>,<span class="st">"Initial"</span>]]</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(stages<span class="op">=</span>indexers)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> pipeline.fit(titanic_df).transform(titanic_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“1094f477-7b01-4ae9-93ed-21c8c89d59a2”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08d: </span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>display(titanic_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-08e-drop-columns-not-required" class="level3">
<h3 class="anchored" data-anchor-id="lab-08e-drop-columns-not-required">Lab 08e: Drop Columns not Required</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“65e9685e-9fac-4002-8fb8-264866a92286”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08s: Drop columns which are not required</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>titanic_df <span class="op">=</span> titanic_df.drop(<span class="st">"PassengerId"</span>,<span class="st">"Name"</span>,<span class="st">"Ticket"</span>,<span class="st">"Cabin"</span>,<span class="st">"Embarked"</span>,<span class="st">"Gender"</span>,<span class="st">"Initial"</span>)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>titanic_df.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-08f-put-all-x-variables-into-a-vector-and-transform.-then-split-into-traintest" class="level3">
<h3 class="anchored" data-anchor-id="lab-08f-put-all-x-variables-into-a-vector-and-transform.-then-split-into-traintest">Lab 08f: Put all X-variables into a Vector and Transform. Then split into TRAIN/TEST</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“87890b9d-e88a-41d9-9b18-bb2717f6af5c”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08f: Put all Features (X-vars) into a Vector</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>feature <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>titanic_df.columns[<span class="dv">1</span>:],outputCol<span class="op">=</span><span class="st">"features"</span>)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>feature_vector<span class="op">=</span> feature.transform(titanic_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“a19b5254-c6fd-4a55-b0e6-c7f9aa3571f5”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08f: Now that the data is all set, let's split it into Training and Test. I'll be using 80% of it.</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>(trainingData, testData) <span class="op">=</span> feature_vector.randomSplit([<span class="fl">0.8</span>, <span class="fl">0.2</span>],seed <span class="op">=</span> <span class="dv">11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-08g-run-decision-tree-classifer-to-create-model-then-make-prediction" class="level3">
<h3 class="anchored" data-anchor-id="lab-08g-run-decision-tree-classifer-to-create-model-then-make-prediction">Lab 08g: Run Decision Tree Classifer to create Model then make Prediction</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“3c66a9c9-8cd1-4ae3-8930-5423e8e73777”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08g: Decision Tree classifier</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.classification <span class="im">import</span> DecisionTreeClassifier</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>trainingData.cache()</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> DecisionTreeClassifier(labelCol<span class="op">=</span><span class="st">"Survived"</span>, featuresCol<span class="op">=</span><span class="st">"features"</span>)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>dt_model <span class="op">=</span> dt.fit(trainingData)</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>dt_prediction <span class="op">=</span> dt_model.transform(testData)</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>dt_prediction.select(<span class="st">"prediction"</span>, <span class="st">"Survived"</span>, <span class="st">"features"</span>).show(<span class="dv">200</span>, <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
<section id="lab-08h-evaluate-accuracy-of-decision-tree" class="level3">
<h3 class="anchored" data-anchor-id="lab-08h-evaluate-accuracy-of-decision-tree">Lab 08h: Evaluate Accuracy of Decision Tree</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“1cfcc7b3-17ac-4fa3-9e6a-10c4e5af5c06”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 0h: 81% Accuracy </span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>dtDF <span class="op">=</span> dt_prediction.select(<span class="st">"prediction"</span>, <span class="st">"Survived"</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>dtDF.createOrReplaceTempView(<span class="st">"gbt_view"</span>)</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>spark.sql(<span class="st">"SELECT (SELECT cast(count(*) as dec(5,2)) FROM gbt_view WHERE cast(prediction as integer) = Survived)/(SELECT cast(count(*) as dec(5,2)) FROM gbt_view)"</span>).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
</section>
</section>
</section>
<section id="end-of-mod-11-mlib-ml" class="level1">
<h1>End of Mod-11 (MLib-ML)</h1>
<section id="ignore-past-here" class="level2">
<h2 class="anchored" data-anchor-id="ignore-past-here">Ignore Past here</h2>
<section id="bonus-lab" class="level3">
<h3 class="anchored" data-anchor-id="bonus-lab">Bonus Lab</h3>
</section>
<section id="goal-linear-regression-predict-home-prices" class="level3">
<h3 class="anchored" data-anchor-id="goal-linear-regression-predict-home-prices">Goal: Linear Regression: Predict Home Prices</h3>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“d66ae5af-6ff2-4b21-9798-18e3c9719eb5”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08a: Load Data</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>homeDF <span class="op">=</span> spark.read.csv(<span class="st">"/FileStore/tables/realestate.csv"</span>, header<span class="op">=</span><span class="va">True</span>, inferSchema<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>homeDF.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“44b32e3f-df76-4353-a62c-43eb538862b6”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08b: Select Y-variable and X-variables</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>homeDF <span class="op">=</span> homeDF.select(<span class="st">"price"</span>, <span class="st">"baths"</span>, <span class="st">"beds"</span>, <span class="st">"sqft"</span>)</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>homeDF <span class="op">=</span> homeDF[homeDF.baths <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>homeDF <span class="op">=</span> homeDF[homeDF.beds <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>homeDF <span class="op">=</span> homeDF[homeDF.sqft <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>display(homeDF)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“6c79d9fb-173c-49c0-a0f2-1eb2bbf8eae0”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08c: Create LabelPoint</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark.mllib</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark.mllib.regression</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.mllib.regression <span class="im">import</span> LabeledPoint</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> <span class="op">*</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>lpRDD <span class="op">=</span> homeDF.rdd.<span class="bu">map</span>(<span class="kw">lambda</span> c:LabeledPoint(c[<span class="dv">0</span>], [c[<span class="dv">1</span>:]]))</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>lpRDD.take(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“dc1d3284-76c7-4558-9266-95e92c519af6”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08d: Via 'summary', notice 'mean' and 'stddev' much higher, so Normalize the Data</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.mllib.feature <span class="im">import</span> StandardScaler</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>homeDF.summary().show()</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Pluck out just X-vars (bath, bed, sqft)</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>xVarRDD <span class="op">=</span> homeDF.rdd.<span class="bu">map</span>(<span class="kw">lambda</span> c: c[<span class="dv">1</span>:])</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize X-vars</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>standarizer <span class="op">=</span> StandardScaler()</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> standarizer.fit(xVarRDD)</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>normalXvarRDD <span class="op">=</span> model.transform(xVarRDD)</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>normalXvarRDD.take(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“20422ef6-8bc7-4c8a-b220-821fef80ed57”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08e: Create new Normalized LabelPoint. Append Y and X-var in new LabelPoint using 'zip()' function</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>YvarRDD <span class="op">=</span> homeDF.rdd.<span class="bu">map</span>(<span class="kw">lambda</span> c: c[<span class="dv">0</span>])</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>newKVRDD <span class="op">=</span> YvarRDD.<span class="bu">zip</span>(normalXvarRDD)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>newKVRDD.take(<span class="dv">3</span>)</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove 'DenseVector'</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>newlpRDD <span class="op">=</span> newKVRDD.<span class="bu">map</span>(<span class="kw">lambda</span> c: LabeledPoint(c[<span class="dv">0</span>], [c[<span class="dv">1</span>]]))</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>newlpRDD.take(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>
<p>::: {.cell application/vnd.databricks.v1+cell=‘{“title”:““,”showTitle”:false,“inputWidgets”:{},“nuid”:“b0657406-de85-4618-8be7-94cfa0bf4508”}’ execution_count=0}</p>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 08f: Create TRAIN/</span><span class="al">TEST</span><span class="co">, Model, Score Model</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark.mllib</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark.mllib.regression</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create TRAIN/</span><span class="al">TEST</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>trainRDD, testRDD <span class="op">=</span> newlpRDD.randomSplit([<span class="fl">.8</span>, <span class="fl">.2</span>], seed <span class="op">=</span><span class="dv">1234</span>)</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.mllib.regression <span class="im">import</span> LinearRegressionWithSGD</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Want 1000 interations with Step size</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>linearModel <span class="op">=</span> LinearRegressionWithSGD.train(trainRDD, <span class="dv">1000</span>, <span class="fl">.2</span>)</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at first 10 rows of </span><span class="al">TEST</span></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>testRDD.take(<span class="dv">10</span>)</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Enter 9th row house X-Var to see what 'Price' prediction it comes up with</span></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Hopefully it'll be close to ACTUAL 'Price' of $181,872</span></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>linearModel.predict([<span class="fl">1.4929</span>, <span class="fl">3.5205</span>, <span class="fl">1.7353</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style scoped="">
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>
</div>
<p>:::</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>